// Attributes
:walkthrough: Scenario Introduction
:user-password: openshift
:namespace: {user-username}-devspaces
:url-element: https://element-matrix.{openshift-app-host}
:url-rocketchat: https://rocketchat-rocketchat.{openshift-app-host}

// URLs
:codeready-url: http://devspaces.{openshift-app-host}/
:invite-url: http://invite-webapp.{openshift-app-host}



:url-docserver: https://docserver-webapp.{openshift-app-host}
//:url-docserver: https://docserver-webapp.apps.cluster-mqpjp.dynamic.redhatworkshops.io/
//:url-docserver: http://0.0.0.0:8080

:docserver-status: pass:a[<img hidden="true" src="invalid-image.jpg" onerror=" \
        fetch('{url-docserver}/status') \
        .then(response => response.text()) \
        .then(data => this.parentElement.innerHTML = 'Status: <div style=&quot;width:15px;height:15px;border-radius:50%;background:lime;display:inline-block&quot;></div>') \
        .catch(error => this.parentElement.innerHTML = 'Status: <div style=&quot;width:15px;height:15px;border-radius:50%;background:red;display:inline-block&quot;></div>') \
      ">]

:freplace: pass:[function replaceTokens(templateString, values) { \
    const valueArray = values.split(',').map(val => val.trim()); \
    let result = templateString; \
    let replaceIndex = 0; \
    while (result.includes('REPLACE') && replaceIndex < valueArray.length) { \
        result = result.replace('REPLACE', valueArray[replaceIndex]); \
        replaceIndex++; \
    } \
    return result; \
}]

//:fdocserver: pass:a[function docserver(target,template,params) { \
//    {freplace} \
//    fetch('{url-docserver}/roomid?user='+params) \
//        .then(response => response.text()) \
//        .then(data => {target.firstChild.data=replaceTokens(text, data);}) \
//        .catch(error => room = 'Error fetching data: ' + error.message); \
//}]

:fdocserver: pass:a[function docserver(target,template,params) { \
    {freplace} \
    fetch('{url-docserver}'+params.trim()) \
        .then(response => response.text()) \
        .then(data => {target.firstChild.data=replaceTokens(text, data);}) \
        .catch(error => room = 'Error fetching data: ' + error.message); \
}]

:fcopy: pass:a[function copy(el) { \
  el.previousElementSibling.select(); \
  text = el.previousElementSibling.textContent; \
  console.log(text); \
  navigator.clipboard.writeText(text + '\n') \
        .then(response => console.log('Text with carriage return copied to clipboard!')) \
        .catch(err => console.error('Failed to copy: ', err)); \
}]

:copypaste: pass:a[ \
<div style="border: 1px solid #f0f0f0; border-bottom-color: #8a8d90; display: flex; align-items: flex-start;"> \
  <textarea readonly style="field-sizing: content;border: none; background-color: #f0f0f0; width: 100%; resize: none; font-size:14px; font-family: monospace;padding: 5px 15px" rows="4">function example() { \
  console.log("Hello {replace-with-previous}!"); \
  return true; \
}</textarea> \
  <button class="mytooltip" onclick="{fcopy} copy(this);" style="border: none; background-color: white; padding: 5px 15px; border-bottom: 1px solid transparent; transition: border-bottom-color 0.2s;"> \
    <svg fill="currentColor" height="1em" width="1em" viewBox="0 0 448 512" aria-hidden="true" role="img" style="vertical-align: -0.125em;"> \
      <path d="M320 448v40c0 13.255-10.745 24-24 24H24c-13.255 0-24-10.745-24-24V120c0-13.255 10.745-24 24-24h72v296c0 30.879 25.121 56 56 56h168zm0-344V0H152c-13.255 0-24 10.745-24 24v368c0 13.255 10.745 24 24 24h272c13.255 0 24-10.745 24-24V128H344c-13.2 0-24-10.8-24-24zm120.971-31.029L375.029 7.029A24 24 0 0 0 358.059 0H352v96h96v-6.059a24 24 0 0 0-7.029-16.97z"></path> \
    </svg> \
    <span class="mytooltiptext">Copy to clipboard</span> \
  </button> \
  <style> \
.mytooltip{position:relative;display:inline-block;border-bottom:1px dotted black}.mytooltip .mytooltiptext{visibility:hidden;width:120px;background-color:#555;color:#fff;text-align:center;border-radius:6px;padding:5px 0;position:absolute;z-index:1;bottom:125%;left:50%;margin-left:-60px;opacity:0;transition:opacity 0.3s}.mytooltip .mytooltiptext::after{content:"";position:absolute;top:100%;left:50%;margin-left:-5px;border-width:5px;border-style:solid;border-color:#555 transparent transparent transparent}.mytooltip:hover .mytooltiptext{visibility:visible;opacity:1} \
  </style> \
</div> \
<img hidden="true" src="invalid-image.jpg" onerror="{ \
  {fdocserver} \
  let txtarea = this.parentElement.querySelector('textarea'); \
  let div = this.closest('.paragraph'); \
  if(!div.closest('.openblock')){div = div.parentElement} \
  let source = div.nextElementSibling; \
  let pre = source.querySelector('pre'); \
  let text = pre.textContent; \
  let lineCount = text.split('\n').length; \
  let tokens = this.nextSibling; \
  console.log('tokens: [' +tokens.data.trim()+']'); \
  if(tokens.data.trim()!=''){docserver(txtarea,text,tokens.data);} else {txtarea.firstChild.data=text;} \
  source.remove(); \
  tokens.remove(); \
  this.remove(); \
}"> \
]

:snippet: pass:a[ \
<div style="border: 1px solid #f0f0f0; border-bottom-color: #8a8d90; display: flex; align-items: flex-start;"> \
</div> \
<img hidden="true" src="invalid-image.jpg" onerror="{ \
  {freplace} \
  let block = this.closest('.openblock'); \
  let div = this.closest('.paragraph'); \
  let source = div.nextElementSibling; \
  let pre = source.querySelector('pre'); \
  let text = pre.textContent; \
  let lineCount = text.split('\n').length; \
  let tokens = this.nextSibling; \
  console.log('tokens: [' +tokens.data.trim()+']'); \
  console.log('before text: [' +text+']'); \
  text = replaceTokens(text, tokens.data.trim()); \
  pre.textContent = text; \
  console.log('after text: [' +text+']'); \
  console.log(block); \
  block.parentElement.insertBefore(pre,block); \
  block.remove(); \
}"> \
]

:room: pass:a[ \
<img hidden="true" src="invalid-image.jpg" onerror="{ \
  let code = this.previousElementSibling; \
  let text = code.textContent; \
  console.log('before text: [' +text+']'); \
  text = text.replace('user', 'room'); \
  code.textContent = text; \
  console.log('after text: [' +text+']'); \
  this.remove(); \
}"> \
]


ifdef::env-github[]
endif::[]

[id='onboarding']
= Lab 1 - (a) - Scenario and Onboarding

Part 1 (out of 2) introduces the first integration flow to implement and helps you to onboard onto the chat platforms.


Prerequisites: +
--
* Ensure you have previously completed the following tiles:
+
image::images/prereq.png[align="left", width=100%]

{empty} +
--

Estimated time: +
--
* *10 mn* +
--

{empty} +

{empty} +

[time=2]
[id="scenario-intro"]
== Data flow overview

The picture below illustrates the data flow traversing our Camel instance:

image::images/data-flow.png[align="center", width=80%]

The above process bridges chat messages from _Matrix_ to _Rocket.Chat_.

* _Matrix_ is an open standard and communication protocol for real-time decentralised communication. It works seamlessly between different service providers.

* _Rocket.Chat_ is also an open-source communications platform with high data protection standards. It enables real-time conversations between colleagues, other companies, or your customers across web, desktop, or mobile devices.

{empty} +

They are both deployed in _OpenShift_ with convenient web access, making them ideal for students to use in this workshop.

The tasks to complete in this lab will guide you on how to onboard to both messaging systems.

{empty} +


[time=2]
[id="matrix-chat"]
== Matrix platform onboarding

TIP: If you're unfamiliar with link:https://matrix.org/[_Matrix_,window="_blank"], it is an open standard and communication protocol for real-time decentralised communication. It works seamlessly between different service providers.

{empty} +

=== Join your Matrix room.

{blank}

. Open _Matrix's_ web client
+
Click on the link below to open the Login page in _Matrix_ (opens a new tab).
+
--
- link:{url-element}[Matrix Login page,window="_blank"]
--
+
{blank}
+
You'll be presented with a Login page.
+
{empty} +

. Login with your credentials
+
You will be prompted to enter your credentials, as shown below:
+
image::images/matrix-login-credentials.jpg[align="left", width=50%]
+
{blank}
+
====
. Enter the following:
+
* `Username`
+
--
{copypaste}
[subs=attributes]
----
{user-username}
----
--
+
* `Password`
+
--
{copypaste}/credentials/im/{user-username}
----
REPLACE
----
--
+
{empty} +
+
. Then, click **_"Sign in"_**
====
+
{empty} +
+
You will be asked to confirm your identity. Enter your password to do so, as shown below:
+
image::images/matrix-login-confirm.jpg[align="left", width=40%]
+
{blank}
+
Confirm by clicking on _"Continue"_.
+
{empty} +
+
Finally, you'll notice, looking at your _Matrix_ screen, a pending invitation to join your room. +
Follow the steps below to accept your invitation:
+
image::images/matrix-room-accept-invite.png[align="left", width=80%]
+
--
. Click on your room.
. And, click on _"Accept"_.
--

{empty} +


[type=verification]
Were you able to join the Matrix room successfully?

{empty} +


[time=2]
[id="rocketchat-chat"]
== Rocket.Chat platform onboarding

TIP: If you're unfamiliar with link:https://www.rocket.chat/[_Rocket.Chat_,window="_blank"], it is an open-source communications platform with high data protection standards. It enables real-time conversations between colleagues, other companies, or your customers across web, desktop, or mobile devices.

{empty} +

=== Join your Rocket.Chat room.

{blank}

. Open _Rockat.Chat's_  web client:
+
Click on the link below to open the Login page in _Rocket.Chat_ (opens a new tab).
+
--
- link:{url-rocketchat}[Rocket.Chat Login page,window="_blank"]
--
+
{empty} +

. You will be prompted to enter your credentials, as shown below:
+
image::images/rchat-login-credentials.png[align="left", width=50%]
+
{blank}
+
====
. Enter the following:
+
* `Username`
+
--
{copypaste}
[subs=attributes]
----
{user-username}
----
--
+
* `Password`
+
--
{copypaste}/credentials/im/{user-username}
----
REPLACE
----
--
+
{empty} +
+
. Then, click **_"Login"_**
====
+
{empty} +

. When you login, you'll see your home page in _Rocket.Chat_, and your room listed in the left panel of your screen, as shown below:
+
image::images/rchat-room.png[align="left", width=50%]

{empty} +

[type=verification]
Were you able to join the _Rocket.Chat_ room successfully?

{empty} +





[time=2]
[id="flow"]
== Preview of the integration flow

=== Process overview

The diagram below illustrates the processing flow you're about to create:

image::images/new/processing-flow.jpg[align="center", width=80%]

There are 3 processing steps in use:

====
* *A source _Kamelet_* +
Consumes events from _Matrix_.

* *A data mapping* +
Transforms _Matrix_ events to _Rocket.Chat_ events (in JSON format).

* *A sink _Kamelet_* +
Produces events to _Rocket.Chat_.
====

{empty} +

=== Prototyping workflow

NOTE: This workshop has been designed with the prototyping workflow in mind.

The prototyping phase is very important as it allows the developer to quickly iterate with fast trial and error runs. Fast iterations translate into fast learning, not only for those new to Camel, but also for experienced developers finding their way by trying out different approaches to solve a problem.

The image below ilustrates the process:

image::images/workflow-camel-user.png[align="center", width=80%]

First, developers use a local environment for rapid inner-loop development cycles. This approach accelerates prototyping and code validation. Once the foundational elements are in place, the application is deployed to an OpenShift environment to validate containerized execution. Any necessary adjustments can then revert to the fast inner-loop cycle.

{empty} +

=== Get ready!

You've reached the end of Part 1. Complete Lab 1 by choosing the next tile (part 2) on your main tutorial dashboard:

image::images/continue-part-2.png[align="center", width=80%]

{empty} +
